# æ–‡ä»¶è·¯å¾„: .github/workflows/cron.yml
name: Update Schedule

on:
  workflow_run:
    # ç›‘å¬ä¸»è„šæœ¬ï¼Œå½“ä¸»è„šæœ¬è¿è¡Œå®Œæˆåè§¦å‘
    workflows: ["HidenCloud Auto Renew (Python)"]
    types:
      - completed

permissions:
  contents: write # å¿…é¡»èµ‹äºˆå†™æƒé™ï¼Œä»¥ä¾¿ä¿®æ”¹ main.yml

jobs:
  update-cron:
    runs-on: ubuntu-latest
    # ä»…å½“ä¸»è„šæœ¬æˆåŠŸè¿è¡Œåæ‰ä¿®æ”¹æ—¶é—´ï¼ˆé¿å…ä¸»è„šæœ¬æŠ¥é”™äº†è¿˜çæ”¹æ—¶é—´ï¼‰
    if: github.event.workflow_run.conclusion == 'success'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: main # ç¡®ä¿æ‹‰å–çš„æ˜¯ä¸»åˆ†æ”¯

      - name: Randomize Cron & Commit
        run: |
          # ç”Ÿæˆ 0-59 ä¹‹é—´çš„éšæœºæ•°
          RANDOM_MINUTE=$(($RANDOM % 59))
          
          # ä½¿ç”¨ sed ä¿®æ”¹ main.yml ä¸­çš„ cron åˆ†é’Ÿæ•°
          # åŒ¹é…è§„åˆ™ï¼šæŸ¥æ‰¾ "- cron: '" å¼€å¤´ï¼Œåé¢è·Ÿæ•°å­—ï¼Œæ›¿æ¢ä¸ºæ–°çš„éšæœºæ•°å­—
          sed -i -E "s/(- cron: ')[0-9]+( .*')/\1${RANDOM_MINUTE}\2/g" .github/workflows/main.yml
          
          echo "ğŸ“… ä¸‹æ¬¡è¿è¡Œåˆ†é’Ÿæ•°å·²ä¿®æ”¹ä¸º: ${RANDOM_MINUTE}"

          # é…ç½® Git ä¿¡æ¯
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # æäº¤å¹¶æ¨é€
          git add .github/workflows/main.yml
          
          # [skip ci] è¡¨ç¤ºè¿™æ¬¡æäº¤ä¸è§¦å‘ CIï¼Œé˜²æ­¢æ­»å¾ªç¯ï¼ˆè™½ç„¶ workflow_run ä¸å—æ­¤å½±å“ï¼Œä½†åŠ ä¸Šæ˜¯ä¸ªå¥½ä¹ æƒ¯ï¼‰
          git commit -m "Update cron schedule to minute $RANDOM_MINUTE [skip ci]" || exit 0
          git push
